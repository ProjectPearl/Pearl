<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="theme-color" content="#141432">
    <title>Submit - PEARL</title>
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <nav>
        <a href="index.html" class="nav-logo">PEARL</a>
        <div class="nav-links">
            <a href="experiments.html">Experiments</a>
            <a href="https://github.com/ProjectPearl/Pearl" target="_blank">GitHub</a>
            <a href="submit.html" class="btn">Submit Data</a>
        </div>
    </nav>
    
    <div class="page-header">
        <h1>Submit Experiment</h1>
        <p>Records are permanent and cannot be edited</p>
    </div>
    
    <div class="form-container">
        <form id="experiment-form">
            <div class="form-section">
                <h3>Basic Info</h3>
                <div class="form-row">
                    <label>
                        <span class="required">Experiment ID</span>
                        <input type="text" name="experiment_id" required pattern="[0-9]{4}_[a-zA-Z0-9_]+" placeholder="0001_balance_test">
                    </label>
                    <label>
                        <span class="required">Contributor</span>
                        <input type="text" name="contributor" required placeholder="github_username">
                    </label>
                </div>
            </div>
            
            <div class="form-section">
                <h3>Task</h3>
                <label>
                    <span class="required">Type</span>
                    <select name="task_type" required>
                        <option value="">Select task type...</option>
                        <option value="balance">Balance</option>
                        <option value="navigation">Navigation</option>
                        <option value="grasping">Grasping</option>
                        <option value="locomotion">Locomotion</option>
                        <option value="tracking">Tracking</option>
                        <option value="avoidance">Avoidance</option>
                        <option value="other">Other</option>
                    </select>
                </label>
                <label>
                    <span class="required">Description</span>
                    <textarea name="task_description" required minlength="10" placeholder="What was the robot trying to do?"></textarea>
                </label>
            </div>
            
            <div class="form-section">
                <h3>Hardware</h3>
                <div class="form-row">
                    <label>
                        <span class="required">Platform</span>
                        <input type="text" name="platform" required placeholder="2-wheel differential">
                    </label>
                    <label>
                        <span class="required">MCU</span>
                        <input type="text" name="mcu" required placeholder="ESP32">
                    </label>
                </div>
                <div class="form-row">
                    <label>
                        <span class="required">Motors</span>
                        <input type="text" name="motors" required placeholder="N20 DC 6V">
                    </label>
                    <label>
                        <span class="required">Power</span>
                        <input type="text" name="power_source" required placeholder="2S LiPo 7.4V">
                    </label>
                </div>
                <label>
                    <span class="required">Sensors</span>
                    <input type="text" name="sensors" required placeholder="MPU6050, HC-SR04 (comma separated)">
                </label>
                <label>
                    <span class="required">Actuators</span>
                    <input type="text" name="actuators" required placeholder="DC motor x2, servo (comma separated)">
                </label>
            </div>
            
            <div class="form-section">
                <h3>Outcome</h3>
                <div class="form-row">
                    <label>
                        <span class="required">Result</span>
                        <select name="success" required>
                            <option value="false">Failed</option>
                            <option value="true">Succeeded</option>
                        </select>
                    </label>
                    <label>
                        <span class="required">Duration (s)</span>
                        <input type="number" name="duration_seconds" required min="0" step="0.1" placeholder="0">
                    </label>
                    <label>
                        <span class="required">Reward</span>
                        <input type="number" name="reward" required step="0.01" placeholder="0">
                    </label>
                </div>
                
                <div id="failure-fields">
                    <label>
                        <span class="required">Failure Mode</span>
                        <select name="failure_mode" required>
                            <option value="">Select failure mode...</option>
                            <option value="control_instability">Control Instability</option>
                            <option value="mechanical_slip">Mechanical Slip</option>
                            <option value="perception_error">Perception Error</option>
                            <option value="actuator_saturation">Actuator Saturation</option>
                            <option value="power_dropout">Power Dropout</option>
                            <option value="sensor_noise">Sensor Noise</option>
                            <option value="collision">Collision</option>
                            <option value="timeout">Timeout</option>
                            <option value="other">Other</option>
                        </select>
                    </label>
                </div>
            </div>
            
            <div class="form-section">
                <h3>Notes</h3>
                <label>
                    <textarea name="notes" rows="3" placeholder="Optional observations"></textarea>
                </label>
            </div>
            
            <button type="submit" class="btn">Submit Experiment</button>
        </form>
        
        <div id="validation-result"></div>
    </div>
    
    <footer>
        <p>PEARL Â· <a href="https://github.com/ProjectPearl/Pearl">GitHub</a></p>
    </footer>
    
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="config.js"></script>
    <script>
        const SUPABASE_URL = (typeof SUPABASE_CONFIG !== 'undefined' && SUPABASE_CONFIG?.url) ? SUPABASE_CONFIG.url : '';
        const SUPABASE_KEY = (typeof SUPABASE_CONFIG !== 'undefined' && SUPABASE_CONFIG?.anonKey) ? SUPABASE_CONFIG.anonKey : '';
        let supabaseClient = null;
        
        function toggleFailureFields() {
            const isSuccess = document.querySelector('select[name="success"]').value === 'true';
            const fields = document.getElementById('failure-fields');
            const select = document.querySelector('select[name="failure_mode"]');
            fields.style.display = isSuccess ? 'none' : 'block';
            select.required = !isSuccess;
            if (isSuccess) select.value = '';
        }
        
        document.addEventListener('DOMContentLoaded', function() {
            if (SUPABASE_URL && SUPABASE_KEY && typeof supabase !== 'undefined') {
                supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
            }
            document.querySelector('select[name="success"]').addEventListener('change', toggleFailureFields);
            toggleFailureFields();
        });
        
        document.getElementById('experiment-form').addEventListener('submit', async function(e) {
            e.preventDefault();
            const form = e.target;
            const success = form.success.value === 'true';
            
            const data = {
                experiment_id: form.experiment_id.value.trim(),
                timestamp: new Date().toISOString(),
                contributor: form.contributor.value.trim(),
                task: { type: form.task_type.value, description: form.task_description.value.trim() },
                hardware: {
                    platform: form.platform.value.trim(),
                    mcu: form.mcu.value.trim(),
                    motors: form.motors.value.trim(),
                    power_source: form.power_source.value.trim(),
                    sensors: form.sensors.value.split(',').map(s => s.trim()).filter(s => s),
                    actuators: form.actuators.value.split(',').map(s => s.trim()).filter(s => s)
                },
                outcome: { success, duration_seconds: parseFloat(form.duration_seconds.value) },
                reward: parseFloat(form.reward.value),
                notes: form.notes.value.trim() || undefined
            };
            
            if (!success) data.outcome.failure_mode = form.failure_mode.value;
            
            if (!supabaseClient) {
                showMsg('Database not connected', 'error');
                return;
            }
            
            const { error } = await supabaseClient.from('experiments').insert([data]);
            if (error) {
                showMsg(error.message, 'error');
            } else {
                showMsg('Experiment submitted successfully', 'success');
                form.reset();
                toggleFailureFields();
            }
        });
        
        function showMsg(msg, type) {
            const div = document.getElementById('validation-result');
            div.className = 'validation-result ' + type;
            div.textContent = msg;
        }
    </script>
</body>
</html>

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="theme-color" content="#0e2b54">
    <meta name="description" content="Browse robotics experiments submitted to PEARL">
    <meta http-equiv="X-Content-Type-Options" content="nosniff">
    <meta http-equiv="X-Frame-Options" content="DENY">
    <meta name="referrer" content="strict-origin-when-cross-origin">
    <link rel="icon" type="image/png" href="favicon.png">
    <link rel="apple-touch-icon" href="apple-touch-icon.png">
    <title>Experiments - PEARL</title>
    <link rel="stylesheet" href="styles.css?v=8">
</head>
<body>
    <nav>
        <a href="index.html" class="nav-logo">PEARL</a>
        <div class="nav-links">
            <a href="about.html">About</a>
            <a href="experiments.html">Experiments</a>
            <a href="https://github.com/ProjectPearl/Pearl" target="_blank" rel="noopener noreferrer">GitHub</a>
            <a href="submit.html" class="btn">Submit Data</a>
        </div>
    </nav>
    <div class="page-header">
        <h1>Experiments</h1>
        <p>Browse submitted experiments</p>
    </div>
    <div class="container">
        <div class="filters">
            <button class="filter-btn" onclick="filter('failures')">Failures</button>
            <button class="filter-btn" onclick="filter('successes')">Successes</button>
            <button class="filter-btn active" onclick="filter('all')">All</button>
        </div>
        <div id="list">
            <div class="loading">Loading experiments...</div>
        </div>
    </div>
    <script>
    (function() {
        'use strict';
        const REPO = 'ProjectPearl/Pearl';
        let experiments = [];
        let currentFilter = 'all';

        function sanitize(str) {
            if (typeof str !== 'string') return '';
            const div = document.createElement('div');
            div.textContent = str;
            return div.innerHTML;
        }

        function parseExperiment(issue) {
            try {
                const match = issue.body?.match(/```json\n([\s\S]*?)\n```/);
                if (!match) return null;
                const data = JSON.parse(match[1]);
                return {
                    id: sanitize(data.experiment_id || ''),
                    task: data.task?.type || '',
                    platform: data.hardware?.platform || '',
                    duration: data.outcome?.duration_seconds || 0,
                    reward: data.reward || 0,
                    success: issue.labels.some(l => l.name === 'success'),
                    failure: issue.labels.some(l => l.name === 'failure'),
                    failureMode: data.outcome?.failure_mode || '',
                    url: issue.html_url
                };
            } catch (e) {
                return null;
            }
        }

        function render() {
            let items = experiments;
            if (currentFilter === 'failures') items = items.filter(e => e.failure || !e.success);
            else if (currentFilter === 'successes') items = items.filter(e => e.success);

            const list = document.getElementById('list');
            if (!items.length) {
                list.innerHTML = '<div class="empty">No experiments found. <a href="submit.html">Submit the first one!</a></div>';
                return;
            }

            list.innerHTML = items.map(e => `
                <a href="${sanitize(e.url)}" target="_blank" rel="noopener noreferrer" style="text-decoration:none;color:inherit;">
                    <div class="card ${e.success ? 'ok' : 'fail'}">
                        <div class="card-header">
                            <span class="card-id">${sanitize(e.id) || 'Experiment'}</span>
                            <span class="badge ${e.success ? 'success' : 'failure'}">${e.success ? 'Success' : 'Failed'}</span>
                        </div>
                        <div class="card-meta">
                            <span class="badge info">${sanitize(e.task)}</span>
                            ${sanitize(e.platform)} · ${e.duration.toFixed(1)}s · Reward: ${e.reward}
                        </div>
                        ${e.failureMode ? `<div class="card-meta" style="margin-top:0.5rem;color:var(--error)">Failure: ${sanitize(e.failureMode.replace(/_/g, ' '))}</div>` : ''}
                    </div>
                </a>
            `).join('');
        }

        window.filter = function(f) {
            currentFilter = f;
            document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
            event.target.classList.add('active');
            render();
        };

        async function init() {
            try {
                const res = await fetch(`https://api.github.com/repos/${REPO}/issues?labels=experiment&state=all&per_page=50`);
                if (!res.ok) throw new Error('API error');
                const issues = await res.json();
                if (!Array.isArray(issues)) throw new Error('Invalid response');
                experiments = issues.map(parseExperiment).filter(Boolean);
                render();
            } catch (e) {
                document.getElementById('list').innerHTML = `<div class="empty">Error loading experiments. <a href="https://github.com/${REPO}/issues?q=label%3Aexperiment" target="_blank" rel="noopener noreferrer">View on GitHub</a></div>`;
            }
        }

        document.addEventListener('DOMContentLoaded', init);
    })();
    </script>
</body>
</html>
